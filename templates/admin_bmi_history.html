{% extends "admin_layout.html" %}

{% block title %}BMI History - Admin Dashboard{% endblock %}

{% block header_title %}BMI History{% endblock %}

{% block additional_styles %}
<style>
  .bmi-category {
    padding: 3px 8px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
  }
  
  .bmi-category.underweight {
    background-color: var(--primary-light);
    color: var(--primary);
  }
  
  .bmi-category.normal {
    background-color: var(--secondary-light);
    color: var(--secondary);
  }
  
  .bmi-category.overweight {
    background-color: var(--accent-light);
    color: var(--accent);
  }
  
  .bmi-category.obese {
    background-color: rgba(220, 38, 38, 0.1);
    color: var(--danger);
  }
  
  .search-tools {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .search-tools input, 
  .search-tools select {
    padding: 10px 15px;
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    background-color: var(--glass-bg);
    transition: var(--transition);
    flex: 1;
    min-width: 150px;
  }
  
  .search-tools input:focus,
  .search-tools select:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px var(--primary-light);
  }
  
  .chart-container {
    width: 100%;
    height: 300px;
    margin-bottom: 20px;
    background-color: var(--glass-bg);
    border-radius: var(--border-radius);
    box-shadow: var(--glass-shadow);
    padding: 20px;
  }
</style>
{% endblock %}

{% block content %}
<!-- Statistics Overview -->
<div class="stats-cards">
  <div class="stat-card">
    <div class="stat-value" id="total-entries">{{ bmi_entries|length }}</div>
    <div class="stat-label">Total Entries</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="avg-bmi">0</div>
    <div class="stat-label">Average BMI</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="underweight-count">0</div>
    <div class="stat-label">Underweight</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="normal-count">0</div>
    <div class="stat-label">Normal</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="overweight-count">0</div>
    <div class="stat-label">Overweight</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="obese-count">0</div>
    <div class="stat-label">Obese</div>
  </div>
</div>

<div class="search-tools">
  <input type="text" id="search-user" placeholder="Search by username...">
  <select id="filter-category">
    <option value="all">All Categories</option>
    <option value="underweight">Underweight</option>
    <option value="normal">Normal</option>
    <option value="overweight">Overweight</option>
    <option value="obese">Obese</option>
  </select>
  <input type="date" id="filter-date" placeholder="Filter by date">
</div>

<div class="card">
  <div class="card-header">
    <h3>All BMI Records</h3>
  </div>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>User</th>
        <th>Height (cm)</th>
        <th>Weight (kg)</th>
        <th>BMI</th>
        <th>Category</th>
        <th>Date Recorded</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="bmi-table">
      {% for entry in bmi_entries %}
      <tr data-bmi-category="{{ entry.bmi_category|lower }}">
        <td>{{ entry.id }}</td>
        <td><a href="{{ url_for('user_history', user_id=entry.user_id) }}" class="btn btn-primary btn-sm">{{ entry.username }}</a></td>
        <td>{{ entry.height }}</td>
        <td>{{ entry.weight }}</td>
        <td>{{ entry.bmi }}</td>
        <td><span class="bmi-category {{ entry.bmi_category|lower }}">{{ entry.bmi_category }}</span></td>
        <td>{{ entry.recorded_at }}</td>
        <td>
          <a href="{{ url_for('user_history', user_id=entry.user_id) }}" class="btn btn-primary btn-sm">View User</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="pagination">
  <a href="#" class="active">1</a>
  <a href="#">2</a>
  <a href="#">3</a>
  <a href="#">Next Â»</a>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-user');
    const categoryFilter = document.getElementById('filter-category');
    const dateFilter = document.getElementById('filter-date');
    const bmiTable = document.getElementById('bmi-table');
    const rows = bmiTable.querySelectorAll('tr');
    
    // Calculate statistics
    let totalBMI = 0;
    let underweightCount = 0;
    let normalCount = 0;
    let overweightCount = 0;
    let obeseCount = 0;
    
    rows.forEach(row => {
      const bmi = parseFloat(row.querySelector('td:nth-child(5)').textContent);
      const category = row.getAttribute('data-bmi-category');
      
      totalBMI += bmi;
      
      if (category === 'underweight') underweightCount++;
      else if (category === 'normal') normalCount++;
      else if (category === 'overweight') overweightCount++;
      else if (category === 'obese') obeseCount++;
    });
    
    const avgBMI = rows.length > 0 ? (totalBMI / rows.length).toFixed(1) : 0;
    
    document.getElementById('avg-bmi').textContent = avgBMI;
    document.getElementById('underweight-count').textContent = underweightCount;
    document.getElementById('normal-count').textContent = normalCount;
    document.getElementById('overweight-count').textContent = overweightCount;
    document.getElementById('obese-count').textContent = obeseCount;
    
    // Filter function
    function filterBMIEntries() {
      const searchTerm = searchInput.value.toLowerCase();
      const filterCategory = categoryFilter.value;
      const filterDateVal = dateFilter.value;
      
      rows.forEach(row => {
        const username = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        const category = row.getAttribute('data-bmi-category');
        const recordDate = row.querySelector('td:nth-child(7)').textContent;
        
        const nameMatch = username.includes(searchTerm);
        const categoryMatch = filterCategory === 'all' || category === filterCategory;
        const dateMatch = !filterDateVal || recordDate.includes(filterDateVal);
        
        row.style.display = nameMatch && categoryMatch && dateMatch ? '' : 'none';
      });
    }
    
    searchInput.addEventListener('input', filterBMIEntries);
    categoryFilter.addEventListener('change', filterBMIEntries);
    dateFilter.addEventListener('change', filterBMIEntries);
  });
</script>
{% endblock %} 