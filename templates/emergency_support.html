{% extends "includes/layout.html" %}

{% block title %}Emergency Support{% endblock %}

{% block additional_styles %}
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Emergency-specific chatbot styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='emergency-styles.css') }}">

<style>
  :root {
    --emergency-red: #e53e3e;
    --emergency-red-dark: #c53030;
    --warning-yellow: #f6ad55;
    --warning-yellow-dark: #ed8936;
    --success-green: #48bb78;
    --success-green-dark: #38a169;
    --info-blue: #4299e1;
    --info-blue-dark: #3182ce;
    --white: #ffffff;
    --light-gray: #f7fafc;
    --medium-gray: #e2e8f0;
    --dark-gray: #4a5568;
    --darker-gray: #2d3748;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --hover-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
  }

  /* WhatsApp specific styles */
  .fab.fa-whatsapp {
    color: var(--whatsapp-green);
  }
  
  button:hover .fab.fa-whatsapp {
    color: white;
  }

  #emergency-support {
    max-width: 1100px;
    margin: 30px auto;
    padding: 30px;
    font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
  }

  .page-header {
    text-align: center;
    margin-bottom: 40px;
    position: relative;
  }

  .page-header h1 {
    font-size: 2.4rem;
    color: var(--darker-gray);
    margin-bottom: 10px;
    font-weight: 700;
  }

  .page-header p {
    font-size: 1.1rem;
    color: var(--dark-gray);
    max-width: 700px;
    margin: 0 auto;
  }

  .page-header::after {
    content: "";
    display: block;
    width: 80px;
    height: 4px;
    background-color: var(--emergency-red);
    margin: 20px auto 0;
    border-radius: 2px;
  }

  .emergency-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
  }

  @media (max-width: 768px) {
    .emergency-container {
      grid-template-columns: 1fr;
    }
  }

  .main-actions {
    background-color: var(--white);
    padding: 30px;
    border-radius: 15px;
    box-shadow: var(--box-shadow);
    text-align: center;
    transition: all 0.3s ease;
  }

  .main-actions:hover {
    box-shadow: var(--hover-shadow);
    transform: translateY(-5px);
  }

  .main-actions h2 {
    font-size: 1.5rem;
    color: var(--darker-gray);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .main-actions h2 i {
    margin-right: 10px;
    color: var(--emergency-red);
  }

  .main-actions p {
    color: var(--dark-gray);
    margin-bottom: 25px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 10px;
    color: var(--white);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .btn i {
    margin-right: 8px;
    font-size: 1.2rem;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .btn-large {
    padding: 15px 30px;
    font-size: 1.1rem;
    width: 80%;
    max-width: 300px;
  }

  .danger {
    background-color: var(--emergency-red);
  }

  .danger:hover {
    background-color: var(--emergency-red-dark);
  }

  .warning {
    background-color: var(--warning-yellow);
  }

  .warning:hover {
    background-color: var(--warning-yellow-dark);
  }

  .info {
    background-color: var(--info-blue);
  }

  .info:hover {
    background-color: var(--info-blue-dark);
  }

  .success {
    background-color: var(--success-green);
  }

  .success:hover {
    background-color: var(--success-green-dark);
  }

  /* Emergency Contacts Styles */
  .emergency-contacts-list {
    margin-top: 20px;
  }

  .contact-card {
    display: flex;
    align-items: center;
    background-color: var(--light-gray);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }

  .contact-card:hover {
    background-color: var(--medium-gray);
  }

  .contact-avatar {
    width: 40px;
    height: 40px;
    background-color: var(--info-blue);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    color: var(--white);
    font-weight: bold;
    font-size: 18px;
  }

  .contact-details {
    flex-grow: 1;
  }

  .contact-name {
    font-weight: 600;
    color: var(--darker-gray);
  }

  .contact-phone {
    font-size: 0.9rem;
    color: var(--dark-gray);
  }

  .contact-relation {
    font-size: 0.8rem;
    color: var(--info-blue);
    font-style: italic;
  }

  .contact-actions {
    display: flex;
    gap: 5px;
  }

  .contact-btn {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--white);
    border: 1px solid var(--medium-gray);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .contact-btn:hover {
    transform: translateY(-2px);
  }

  .contact-btn-call {
    color: var(--success-green);
  }

  .contact-btn-call:hover {
    background-color: var(--success-green);
    color: var(--white);
  }

  .contact-btn-message {
    color: var(--info-blue);
  }

  .contact-btn-message:hover {
    background-color: var(--info-blue);
    color: var(--white);
  }

  .contact-btn-remove {
    color: var(--emergency-red);
  }

  .contact-btn-remove:hover {
    background-color: var(--emergency-red);
    color: var(--white);
  }

  .no-contacts-message {
    text-align: center;
    padding: 20px;
    color: var(--dark-gray);
  }

  /* Medical ID Card Styles */
  .medical-id-section {
    background-color: var(--white);
    padding: 30px;
    border-radius: 15px;
    box-shadow: var(--box-shadow);
    margin-bottom: 40px;
    text-align: center;
  }

  .medical-id-section h2 {
    font-size: 1.5rem;
    color: var(--darker-gray);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .medical-id-section h2 i {
    margin-right: 10px;
    color: var(--info-blue);
  }

  .medical-id-section > p {
    color: var(--dark-gray);
    margin-bottom: 25px;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }

  .medical-id-card {
    background-color: var(--light-gray);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--box-shadow);
    max-width: 600px;
    margin: 0 auto;
    border: 1px solid var(--medium-gray);
  }

  .card-header {
    background-color: var(--info-blue);
    color: var(--white);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-header h3 {
    margin: 0;
    font-size: 1.2rem;
  }

  .medical-id-edit {
    cursor: pointer;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .medical-id-edit:hover {
    background-color: rgba(255, 255, 255, 0.3);
    transform: rotate(15deg);
  }

  .card-content {
    padding: 20px;
    text-align: left;
  }

  .medical-id-row {
    display: flex;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--medium-gray);
  }

  .medical-id-row:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .medical-id-label {
    font-weight: 600;
    color: var(--darker-gray);
    width: 120px;
    flex-shrink: 0;
  }

  .medical-id-value {
    color: var(--dark-gray);
    flex-grow: 1;
  }

  .card-actions {
    padding: 15px 20px;
    background-color: var(--white);
    display: flex;
    justify-content: center;
    gap: 15px;
  }

  /* First Aid Guides Styles */
  .first-aid-section {
    background-color: var(--white);
    padding: 30px;
    border-radius: 15px;
    box-shadow: var(--box-shadow);
    margin-bottom: 40px;
    text-align: center;
  }

  .first-aid-section h2 {
    font-size: 1.5rem;
    color: var(--darker-gray);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .first-aid-section h2 i {
    margin-right: 10px;
    color: var(--emergency-red);
  }

  .first-aid-section > p {
    color: var(--dark-gray);
    margin-bottom: 25px;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }

  .first-aid-guides {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .guide-card {
    background-color: var(--light-gray);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .guide-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--hover-shadow);
  }

  .guide-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: rgba(229, 62, 62, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
  }

  .guide-icon i {
    font-size: 24px;
    color: var(--emergency-red);
  }

  .guide-card h3 {
    margin: 0 0 5px;
    color: var(--darker-gray);
  }

  .guide-card p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--dark-gray);
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
  }

  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .modal-container {
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    background-color: var(--white);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: scale(0.8);
    transition: transform 0.3s;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }

  .modal-overlay.active .modal-container {
    transform: scale(1);
  }

  .modal-header {
    background-color: var(--info-blue);
    color: var(--white);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--white);
    font-size: 24px;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
  }

  .modal-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }

  .modal-body {
    padding: 20px;
    overflow-y: auto;
  }

  .modal-footer {
    padding: 15px 20px;
    background-color: var(--light-gray);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  /* Form Styles */
  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--darker-gray);
  }

  .form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--medium-gray);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s;
    color: var(--darker-gray);
  }

  .form-control:focus {
    border-color: var(--info-blue);
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
    outline: none;
  }
  
  .form-text {
    display: block;
    margin-top: 5px;
    font-size: 0.8rem;
    color: var(--dark-gray);
  }
  
  .text-muted {
    opacity: 0.8;
  }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .btn-large {
      width: 100%;
      max-width: none;
    }
    
    .medical-id-row {
      flex-direction: column;
    }
    
    .medical-id-label {
      width: 100%;
      margin-bottom: 5px;
    }
    
    .first-aid-guides {
      grid-template-columns: 1fr 1fr;
    }
  }

  @media (max-width: 480px) {
    .first-aid-guides {
      grid-template-columns: 1fr;
    }
    
    .medical-id-card {
      width: 100%;
    }
  }

  /* Additional styles for emergency features */
  .progress-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    color: white;
  }

  .progress-content {
    text-align: center;
    max-width: 400px;
    padding: 20px;
  }

  .progress-spinner {
    width: 60px;
    height: 60px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--white);
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .progress-message {
    font-size: 1.2rem;
    margin-bottom: 15px;
  }

  .progress-status {
    font-size: 1rem;
    margin-bottom: 20px;
    opacity: 0.8;
  }

  .countdown {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 15px;
  }

  .cancel-btn {
    padding: 10px 20px;
    background-color: white;
    color: #e53e3e;
    border: none;
    border-radius: 30px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .cancel-btn:hover {
    background-color: #f8f8f8;
    transform: scale(1.05);
  }

  .location-info {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    text-align: left;
  }

  .location-info .info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .location-info .info-label {
    font-weight: 600;
    opacity: 0.9;
  }

  .location-info .info-value {
    font-family: monospace;
  }

  .success-overlay {
    background-color: rgba(72, 187, 120, 0.9);
  }

  .emergency-success-icon {
    font-size: 60px;
    color: white;
    margin-bottom: 20px;
  }

  .success-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 10px;
  }

  .success-message {
    margin-bottom: 20px;
    opacity: 0.9;
  }

  .done-btn {
    padding: 10px 25px;
    background-color: white;
    color: var(--success-green);
    border: none;
    border-radius: 30px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .done-btn:hover {
    background-color: #f8f8f8;
    transform: scale(1.05);
  }

  .emergency-error {
    background-color: rgba(229, 62, 62, 0.9);
  }

  /* Emergency Contact List Styles */
  .contact-list {
    margin-top: 20px;
  }
  
  .contact-list-item {
    background-color: white;
    border-radius: 10px;
    margin-bottom: 12px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  .contact-list-item:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }
  
  .contact-list-header {
    display: flex;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    background-color: #f8fafc;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .contact-avatar-large {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--info-blue);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 600;
    margin-right: 15px;
    flex-shrink: 0;
  }
  
  .contact-info {
    flex-grow: 1;
  }
  
  .contact-name-large {
    font-size: 16px;
    font-weight: 600;
    color: var(--darker-gray);
    margin-bottom: 3px;
  }
  
  .contact-relation-large {
    font-size: 13px;
    color: var(--info-blue);
    font-style: italic;
  }
  
  .contact-list-body {
    padding: 15px;
    display: none;
    background-color: white;
  }
  
  .contact-list-body.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }
  
  .contact-field {
    margin-bottom: 15px;
  }
  
  .contact-field-label {
    font-size: 12px;
    color: var(--dark-gray);
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .contact-field-value {
    font-size: 14px;
    color: var(--darker-gray);
    font-weight: 500;
  }
  
  .contact-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
  }
  
  .contact-action-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .contact-action-btn i {
    margin-right: 8px;
    font-size: 16px;
  }
  
  .call-btn {
    background-color: var(--success-green);
    color: white;
  }
  
  .call-btn:hover {
    background-color: var(--success-green-dark);
  }
  
  .message-btn {
    background-color: var(--info-blue);
    color: white;
  }
  
  .message-btn:hover {
    background-color: var(--info-blue-dark);
  }
  
  .edit-btn {
    background-color: var(--light-gray);
    color: var(--dark-gray);
  }
  
  .edit-btn:hover {
    background-color: var(--medium-gray);
  }
  
  .delete-btn {
    background-color: var(--light-gray);
    color: var(--emergency-red);
  }
  
  .delete-btn:hover {
    background-color: var(--medium-gray);
  }
  
  .chevron-icon {
    margin-left: 10px;
    color: var(--dark-gray);
    transition: transform 0.3s ease;
  }
  
  .contact-list-header.active .chevron-icon {
    transform: rotate(180deg);
  }
  
  .no-contacts {
    text-align: center;
    padding: 40px 20px;
    color: var(--dark-gray);
    background-color: #f8fafc;
    border-radius: 10px;
    margin-top: 20px;
  }
  
  .no-contacts i {
    font-size: 48px;
    color: var(--medium-gray);
    margin-bottom: 15px;
  }
  
  .no-contacts p {
    margin-bottom: 15px;
  }
  
  .calling-overlay {
    background-color: rgba(72, 187, 120, 0.95);
  }
  
  .call-animation {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    animation: pulse 1.5s infinite;
  }
  
  .call-animation i {
    font-size: 50px;
    color: white;
  }
  
  @keyframes pulse {
    0% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
    }
    
    70% {
      transform: scale(1);
      box-shadow: 0 0 0 15px rgba(255, 255, 255, 0);
    }
    
    100% {
      transform: scale(0.95);
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
    }
  }
  
  .call-status {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
  }
  
  .call-number {
    font-size: 18px;
    margin-bottom: 30px;
    opacity: 0.9;
  }
  
  .message-overlay {
    background-color: rgba(66, 153, 225, 0.95);
  }
  
  .message-form {
    width: 100%;
    max-width: 400px;
  }
  
  .message-textarea {
    width: 100%;
    height: 120px;
    border-radius: 10px;
    border: none;
    padding: 15px;
    margin-bottom: 15px;
    font-family: inherit;
    resize: none;
  }
  
  .message-textarea:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
  }
  
  .message-actions {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }
  
  .send-btn {
    flex-grow: 1;
    padding: 12px;
    background-color: white;
    color: var(--info-blue);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .send-btn:hover {
    background-color: #f8f8f8;
    transform: translateY(-2px);
  }

  /* Emergency Contacts section in the grid */
  .contacts-card {
    background-color: var(--white);
    padding: 30px;
    border-radius: 15px;
    box-shadow: var(--box-shadow);
    text-align: center;
    transition: all 0.3s ease;
  }

  .contacts-card:hover {
    box-shadow: var(--hover-shadow);
    transform: translateY(-5px);
  }

  .contacts-card h2 {
    font-size: 1.5rem;
    color: var(--darker-gray);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .contacts-card h2 i {
    margin-right: 10px;
    color: var(--info-blue);
  }

  .contacts-card p {
    color: var(--dark-gray);
    margin-bottom: 25px;
  }

  .emergency-contacts-container {
    margin-top: 20px;
  }

  .add-contact-card {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background-color: #f8fafc;
    border: 2px dashed #cbd5e0;
    border-radius: 10px;
    margin-top: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .add-contact-card:hover {
    background-color: #ebf8ff;
    border-color: var(--info-blue);
  }

  .add-contact-card i {
    font-size: 24px;
    color: var(--info-blue);
    margin-right: 10px;
  }

  .add-contact-card span {
    font-weight: 500;
    color: var(--info-blue);
  }

  /* Styling for anchor tag buttons */
  a.contact-action-btn, a.btn {
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  a.btn:hover, a.contact-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  a.btn:active, a.contact-action-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Contact card reminder */
  .whatsapp-reminder {
    display: block;
    font-size: 0.8rem;
    color: var(--dark-gray);
    margin-top: 5px;
    text-align: center;
  }

  @keyframes pulse-emergency {
    0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7);
    }
    
    70% {
      transform: scale(1.02);
      box-shadow: 0 0 0 15px rgba(229, 62, 62, 0);
    }
    
    100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(229, 62, 62, 0);
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Emergency Support Section -->
<section id="emergency-support" class="emergency-section">

  <!-- Removing emergency-specific chatbot toggler to prevent duplication -->
  <!-- The main chatbot toggler from layout.html will be used instead -->

  <div class="page-header">
    <h1>Emergency Support</h1>
    <p>Fast access to emergency services and support when you need it most. Our tools help you quickly contact emergency services, share your location, and get medical guidance.</p>
  </div>

  <div class="emergency-container">
    <!-- Main Emergency Actions -->
    <div class="main-actions">
      <h2><i class="fas fa-ambulance"></i>Emergency Contact</h2>
      <p style="margin-bottom: 5px;">Need immediate help? Tap below to call emergency services.</p>
      
      <!-- Indian Emergency Services Info -->
      <div style="background-color: rgba(66, 153, 225, 0.1); border: 1px solid rgba(66, 153, 225, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 0.95rem;">
        <h4 style="margin-top: 0; font-size: 1.1rem; color: #2b6cb0;"><i class="fas fa-info-circle"></i> Indian Emergency Numbers</h4>
        <ul style="margin: 0; padding-left: 20px; color: #4a5568;">
          <li><strong>112</strong> - Unified Emergency Number</li>
          <li><strong>100</strong> - Police</li>
          <li><strong>101</strong> - Fire Services</li>
          <li><strong>108</strong> - Ambulance & Medical</li>
          <li><strong>181</strong> - Women Helpline</li>
          <li><strong>1098</strong> - Child Helpline</li>
        </ul>
      </div>
      
      <!-- Big, unmissable emergency call button -->
      <div style="margin: 20px 0;">
        <a href="tel:112" class="btn danger btn-large" id="emergency-call-button" style="display: flex; align-items: center; justify-content: center; padding: 20px; font-size: 1.3rem; width: 100%; max-width: none; animation: pulse-emergency 2s infinite;">
          <i class="fas fa-phone-alt" style="font-size: 1.5rem; margin-right: 15px;"></i> 
          <div style="text-align: left;">
            <div>CALL EMERGENCY SERVICES</div>
            <div style="font-size: 0.8em; opacity: 0.9;">Tap to call 112 immediately</div>
          </div>
        </a>
      </div>
      
      <!-- Secondary emergency options -->
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <a href="tel:108" class="btn warning" style="flex: 1; text-align: center;">
          <i class="fas fa-plus-circle"></i> Medical<br>Helpline
        </a>
        <a href="tel:101" class="btn warning" style="flex: 1; text-align: center;">
          <i class="fas fa-fire"></i> Fire<br>Department
        </a>
        <a href="tel:100" class="btn warning" style="flex: 1; text-align: center;">
          <i class="fas fa-shield-alt"></i> Police<br>Emergency
        </a>
      </div>
      
      <button class="btn warning btn-large" onclick="shareLocation()" style="margin-top: 15px;">
        <i class="fas fa-map-marker-alt"></i> Share My Location
      </button>

      <div style="margin-top: 20px; text-align: right;">
        <button class="btn info" style="padding: 8px 15px; font-size: 0.9rem;" onclick="openEmergencySettings()">
          <i class="fas fa-cog"></i> Configure Emergency Number
        </button>
      </div>
    </div>

    <!-- Emergency Contacts -->
    <div class="contacts-card">
      <h2><i class="fas fa-address-book"></i>Emergency Contacts</h2>
      <p>Quickly contact your designated emergency contacts in case of medical situations.</p>
      
      <div class="emergency-contacts-container" id="emergency-contacts-container">
        <!-- Emergency contacts will be loaded here -->
      </div>
      
      <div class="add-contact-card" onclick="openAddContactModal()">
        <i class="fas fa-plus-circle"></i>
        <span>Add New Emergency Contact</span>
      </div>
    </div>
  </div>

  <!-- Medical ID Card Section -->
  <div class="medical-id-section">
    <h2><i class="fas fa-id-card-alt"></i> Medical ID Card</h2>
    <p>Your digital medical ID card contains essential health information that can be crucial in emergencies.</p>
    
    <div class="medical-id-card" id="medical-id-card">
      <div class="card-header">
        <h3>Medical ID</h3>
        <span class="medical-id-edit" onclick="editMedicalId()"><i class="fas fa-pencil-alt"></i></span>
      </div>
      
      <div class="card-content" id="medical-id-content">
        <div class="medical-id-row">
          <span class="medical-id-label">Name:</span>
          <span class="medical-id-value" id="medical-id-name">John Doe</span>
        </div>
        
        <div class="medical-id-row">
          <span class="medical-id-label">DOB:</span>
          <span class="medical-id-value" id="medical-id-dob">01/01/1980</span>
        </div>
        
        <div class="medical-id-row">
          <span class="medical-id-label">Blood Type:</span>
          <span class="medical-id-value" id="medical-id-blood">O+</span>
        </div>
        
        <div class="medical-id-row">
          <span class="medical-id-label">Allergies:</span>
          <span class="medical-id-value" id="medical-id-allergies">Penicillin, Peanuts</span>
        </div>
        
        <div class="medical-id-row">
          <span class="medical-id-label">Conditions:</span>
          <span class="medical-id-value" id="medical-id-conditions">Asthma, Diabetes</span>
        </div>
        
        <div class="medical-id-row">
          <span class="medical-id-label">Medications:</span>
          <span class="medical-id-value" id="medical-id-medications">Insulin, Albuterol</span>
        </div>
      </div>
      
      <div class="card-actions">
        <button class="btn info" onclick="shareMedicalId()">
          <i class="fas fa-share-alt"></i> Share
        </button>
        
        <button class="btn success" onclick="downloadMedicalId()">
          <i class="fas fa-download"></i> Download
        </button>
      </div>
    </div>
  </div>

  <!-- First Aid Guides Section -->
  <div class="first-aid-section">
    <h2><i class="fas fa-first-aid"></i> First Aid Guides</h2>
    <p>Quick access to emergency first aid procedures to help in critical situations.</p>
    
    <div class="first-aid-guides">
      <div class="guide-card" onclick="showFirstAidGuide('cpr')">
        <div class="guide-icon"><i class="fas fa-heartbeat"></i></div>
        <h3>CPR</h3>
        <p>Cardiopulmonary Resuscitation</p>
      </div>
      
      <div class="guide-card" onclick="showFirstAidGuide('choking')">
        <div class="guide-icon"><i class="fas fa-lungs"></i></div>
        <h3>Choking</h3>
        <p>Heimlich Maneuver</p>
      </div>
      
      <div class="guide-card" onclick="showFirstAidGuide('bleeding')">
        <div class="guide-icon"><i class="fas fa-tint"></i></div>
        <h3>Bleeding</h3>
        <p>Control serious bleeding</p>
      </div>
      
      <div class="guide-card" onclick="showFirstAidGuide('burns')">
        <div class="guide-icon"><i class="fas fa-fire"></i></div>
        <h3>Burns</h3>
        <p>First, second and third degree</p>
      </div>
    </div>
  </div>

  {# Removed emergency chatbot include #}
</section>

{% block additional_scripts %}
<script>
  // Emergency Contacts Storage
  let emergencyContacts = JSON.parse(localStorage.getItem('emergencyContacts')) || [];
  let currentContactId = null;
  let medicalIdData = JSON.parse(localStorage.getItem('medicalIdData')) || {
    name: 'John Doe',
    dob: '1980-01-01',
    blood: 'O+',
    allergies: 'Penicillin, Peanuts',
    conditions: 'Asthma, Diabetes',
    medications: 'Insulin, Albuterol'
  };
  
  // Emergency configurations
  let emergencyConfig = JSON.parse(localStorage.getItem('emergencyConfig')) || {
    emergencyNumber: '112', // India's unified emergency number
    country: 'IN',
    // Add other configuration options as needed
  };

  // First Aid Guides Data
  const firstAidGuides = {
    cpr: {
      title: "CPR (Cardiopulmonary Resuscitation)",
      content: `
        <div class="guide-steps">
          <h4>Adult CPR Steps:</h4>
          <ol>
            <li><strong>Check if the person is responsive</strong> by tapping their shoulder and shouting "Are you OK?"</li>
            <li><strong>Call emergency services (911)</strong> or ask someone else to call if the person is unresponsive.</li>
            <li><strong>Place the person on their back</strong> on a firm, flat surface.</li>
            <li><strong>Begin chest compressions:</strong>
              <ul>
                <li>Place the heel of one hand on the center of the chest (over the lower half of the breastbone).</li>
                <li>Place your other hand on top and interlock your fingers.</li>
                <li>Keep your arms straight and position your shoulders directly above your hands.</li>
                <li>Press down hard at least 2 inches (5 cm) at a rate of 100-120 compressions per minute.</li>
              </ul>
            </li>
            <li><strong>Open the airway</strong> by tilting the head back slightly and lifting the chin.</li>
            <li><strong>Give rescue breaths</strong> (optional during COVID-19 pandemic):
              <ul>
                <li>Pinch the person's nose closed and cover their mouth with yours, creating a seal.</li>
                <li>Give 2 rescue breaths (each lasting about 1 second), watching for the chest to rise.</li>
              </ul>
            </li>
            <li><strong>Continue CPR</strong> with cycles of 30 chest compressions followed by 2 rescue breaths until help arrives or the person shows signs of life.</li>
          </ol>
          <div class="important-note">
            <h4>Important Notes:</h4>
            <ul>
              <li>Hands-only CPR (compression only, no rescue breaths) is recommended for untrained rescuers.</li>
              <li>If an AED (Automated External Defibrillator) is available, use it as soon as possible.</li>
              <li>CPR for children and infants involves modified techniques - use gentler compressions and different hand positions.</li>
            </ul>
          </div>
        </div>
      `
    },
    choking: {
      title: "Choking (Heimlich Maneuver)",
      content: `
        <div class="guide-steps">
          <h4>For a Conscious Adult or Child:</h4>
          <ol>
            <li><strong>Stand behind the person</strong> and wrap your arms around their waist.</li>
            <li><strong>Make a fist</strong> with one hand and place it slightly above the person's navel (belly button).</li>
            <li><strong>Grab your fist</strong> with your other hand.</li>
            <li><strong>Press hard into the abdomen</strong> with quick, upward thrusts, as if trying to lift the person.</li>
            <li><strong>Repeat thrusts</strong> until the object is dislodged or the person becomes unconscious.</li>
          </ol>
          
          <h4>For an Unconscious Person:</h4>
          <ol>
            <li><strong>Place the person on their back</strong> on a firm surface.</li>
            <li><strong>Call emergency services (911)</strong> or ask someone else to call.</li>
            <li><strong>Begin CPR</strong>, starting with chest compressions. The pressure from compressions may dislodge the object.</li>
            <li><strong>Look in the mouth</strong> before giving rescue breaths. If you see an object, remove it.</li>
            <li><strong>Continue CPR</strong> until help arrives or the person starts breathing normally.</li>
          </ol>
          
          <h4>For Self-Treatment (When Alone):</h4>
          <ol>
            <li><strong>Make a fist</strong> with one hand and place it slightly above your navel.</li>
            <li><strong>Grab your fist</strong> with your other hand and press hard into your abdomen with quick, upward thrusts.</li>
            <li><strong>Alternatively</strong>, lean over a firm object like the back of a chair and press your upper abdomen against it with quick thrusts.</li>
          </ol>
        </div>
      `
    },
    bleeding: {
      title: "Bleeding Control",
      content: `
        <div class="guide-steps">
          <h4>Steps to Control Serious Bleeding:</h4>
          <ol>
            <li><strong>Apply direct pressure</strong> to the wound:
              <ul>
                <li>Use a clean cloth, gauze, or even your hand if nothing else is available.</li>
                <li>Press firmly on the wound.</li>
                <li>If blood soaks through, add more material without removing the first layer.</li>
              </ul>
            </li>
            <li><strong>Elevate the injured area</strong> above the level of the heart if possible.</li>
            <li><strong>Apply pressure to the artery</strong> supplying the area:
              <ul>
                <li>For arm wounds, press the brachial artery on the inner side of the upper arm.</li>
                <li>For leg wounds, press the femoral artery in the groin area.</li>
              </ul>
            </li>
            <li><strong>Use a tourniquet</strong> as a last resort if bleeding cannot be controlled by other methods:
              <ul>
                <li>Place it 2-3 inches above the wound, but not on a joint.</li>
                <li>Tighten until bleeding stops.</li>
                <li>Note the time applied and do not remove once applied.</li>
              </ul>
            </li>
            <li><strong>Keep the person warm</strong> by covering them with a blanket.</li>
            <li><strong>Call emergency services (911)</strong> or get the person to emergency care as soon as possible.</li>
          </ol>
          
          <div class="important-note">
            <h4>Warning Signs of Severe Blood Loss:</h4>
            <ul>
              <li>Confusion or disorientation</li>
              <li>Cold, clammy skin</li>
              <li>Weak, rapid pulse</li>
              <li>Low blood pressure</li>
              <li>Rapid, shallow breathing</li>
              <li>Extreme thirst</li>
              <li>Loss of consciousness</li>
            </ul>
          </div>
        </div>
      `
    },
    burns: {
      title: "Burn Treatment",
      content: `
        <div class="guide-steps">
          <h4>First-Degree Burns (Superficial):</h4>
          <ol>
            <li><strong>Cool the burn</strong> with cool (not cold) running water for 10-15 minutes.</li>
            <li><strong>Do not use ice</strong> as it can damage the skin further.</li>
            <li><strong>Apply aloe vera gel</strong> or moisturizer to soothe the area.</li>
            <li><strong>Take over-the-counter pain relievers</strong> if needed.</li>
            <li><strong>Cover with a sterile, non-stick bandage</strong> if necessary.</li>
          </ol>
          
          <h4>Second-Degree Burns (Partial Thickness):</h4>
          <ol>
            <li><strong>Cool the burn</strong> with cool running water for 15-20 minutes.</li>
            <li><strong>Do not break blisters</strong> as they protect against infection.</li>
            <li><strong>After cooling</strong>, cover with a dry, sterile bandage or clean cloth.</li>
            <li><strong>Do not apply butter, oil, or ointments</strong> to the burn.</li>
            <li><strong>Seek medical attention</strong> if the burn is larger than 3 inches, or on the face, hands, feet, genitals, or major joints.</li>
          </ol>
          
          <h4>Third-Degree Burns (Full Thickness):</h4>
          <ol>
            <li><strong>Call emergency services (911)</strong> immediately.</li>
            <li><strong>Do not remove clothing</strong> stuck to the burn.</li>
            <li><strong>Do not immerse large severe burns</strong> in water as it can cause shock.</li>
            <li><strong>Cover the area</strong> with a cool, moist, sterile bandage or clean cloth.</li>
            <li><strong>Elevate the burned area</strong> above heart level if possible.</li>
            <li><strong>Monitor for signs of shock</strong> until emergency help arrives.</li>
          </ol>
          
          <div class="warning-note">
            <h4>Important Warning:</h4>
            <p>For chemical or electrical burns, large burns, or burns on the face or genitals, call emergency services immediately. Do not attempt to treat severe burns yourself.</p>
          </div>
        </div>
      `
    }
  };

  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
    // Load emergency contacts
    refreshContactsList();
    
    // Load medical ID data
    loadMedicalIdData();
    
    // Load emergency settings
    loadEmergencySettings();
    
    // Update emergency call button text
    updateEmergencyButtonText();
    
    // Update SOS panel emergency numbers
    updateSOSEmergencyNumbers();
  });
  
  // Update emergency call button text
  function updateEmergencyButtonText() {
    const emergencyButton = document.getElementById('emergency-call-button');
    if (emergencyButton) {
      // Update both the text and the href attribute
      emergencyButton.innerHTML = `
        <i class="fas fa-phone-alt" style="font-size: 1.5rem; margin-right: 15px;"></i> 
        <div style="text-align: left;">
          <div>CALL EMERGENCY SERVICES</div>
          <div style="font-size: 0.8em; opacity: 0.9;">Tap to call ${emergencyConfig.emergencyNumber} immediately</div>
        </div>
      `;
      emergencyButton.href = `tel:${emergencyConfig.emergencyNumber}`;
    }
    
    // Also update the secondary emergency buttons based on country
    updateSecondaryEmergencyButtons();
  }
  
  // Update secondary emergency buttons based on country
  function updateSecondaryEmergencyButtons() {
    const medicalButton = document.querySelector('.btn.warning[href^="tel:112"]');
    const fireButton = document.querySelector('.btn.warning[href^="tel:101"]');
    
    if (!medicalButton || !fireButton) return;
    
    // Set appropriate numbers based on country
    switch(emergencyConfig.country) {
      case 'US':
        medicalButton.href = 'tel:911';
        medicalButton.innerHTML = '<i class="fas fa-plus-circle"></i> Medical<br>Emergency';
        fireButton.href = 'tel:911';
        fireButton.innerHTML = '<i class="fas fa-fire"></i> Fire<br>Emergency';
        break;
      case 'UK':
        medicalButton.href = 'tel:111';
        medicalButton.innerHTML = '<i class="fas fa-plus-circle"></i> NHS<br>Helpline';
        fireButton.href = 'tel:999';
        fireButton.innerHTML = '<i class="fas fa-fire"></i> Fire<br>Emergency';
        break;
      case 'IN':
        medicalButton.href = 'tel:108';
        medicalButton.innerHTML = '<i class="fas fa-plus-circle"></i> Medical<br>Helpline';
        fireButton.href = 'tel:101';
        fireButton.innerHTML = '<i class="fas fa-fire"></i> Fire<br>Brigade';
        break;
      default:
        medicalButton.href = 'tel:112';
        medicalButton.innerHTML = '<i class="fas fa-plus-circle"></i> Medical<br>Helpline';
        fireButton.href = 'tel:112';
        fireButton.innerHTML = '<i class="fas fa-fire"></i> Fire<br>Emergency';
        break;
    }
  }

  // Emergency Contact Functions
  function refreshContactsList() {
    const contactsContainer = document.getElementById('emergency-contacts-container');
    
    if (emergencyContacts.length === 0) {
      contactsContainer.innerHTML = `
        <div class="no-contacts">
          <i class="fas fa-user-friends"></i>
          <p>You haven't added any emergency contacts yet.</p>
          <p>Add contacts who should be notified in case of emergency.</p>
        </div>
      `;
    } else {
      let contactsHTML = '<div class="contact-list">';
      
      contactsHTML += `
        <div class="note-card" style="background-color: #fff8dc; border-left: 4px solid #ffd700; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
          <h4 style="margin-top: 0; color: #333;"><i class="fas fa-exclamation-circle"></i> Important Note</h4>
          <p style="margin-bottom: 5px;">For emergency services in India, use the short emergency codes (112, 100, 101, 108, etc.).</p>
          <p style="margin-bottom: 0;">Use direct calling for all emergency contacts as these numbers cannot be reached via messaging apps.</p>
        </div>
      `;
      
      emergencyContacts.forEach((contact, index) => {
        const initials = contact.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const phoneFormatted = contact.phone.replace(/\s+|-|\(|\)/g, '');
        
        contactsHTML += `
          <div class="contact-list-item" data-index="${index}">
            <div class="contact-list-header" onclick="toggleContactDetails(${index})">
              <div class="contact-avatar-large">${initials}</div>
              <div class="contact-info">
                <div class="contact-name-large">${contact.name}</div>
                <div class="contact-relation-large">${contact.relation}</div>
              </div>
              <i class="fas fa-chevron-down chevron-icon"></i>
            </div>
            <div class="contact-list-body" id="contact-details-${index}">
              <div class="contact-field" style="display: flex; align-items: center; margin-bottom: 20px;">
                <div style="flex-grow: 1;">
                  <div class="contact-field-label">Phone Number</div>
                  <div class="contact-field-value" style="font-size: 1.2em; font-weight: bold;">${contact.phone}</div>
                </div>
                <a href="tel:${phoneFormatted}" class="btn danger" style="min-width: 120px; text-align: center;">
                  <i class="fas fa-phone-alt"></i> Call Now
                </a>
              </div>
              ${contact.notes ? `
                <div class="contact-field">
                  <div class="contact-field-label">Notes</div>
                  <div class="contact-field-value">${contact.notes}</div>
                </div>
              ` : ''}
              <div class="contact-actions">
                <a href="tel:${phoneFormatted}" class="contact-action-btn call-btn">
                  <i class="fas fa-phone-alt"></i> Direct Call
                </a>
                <a href="sms:${phoneFormatted}" class="contact-action-btn message-btn" style="background-color: #6b7280;">
                  <i class="fas fa-sms"></i> SMS
                </a>
              </div>
              <div class="contact-actions" style="margin-top: 10px;">
                <button class="contact-action-btn edit-btn" onclick="editContact(${index})">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="contact-action-btn delete-btn" onclick="removeContact(${index})">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        `;
      });
      
      contactsHTML += '</div>';
      contactsContainer.innerHTML = contactsHTML;
    }
  }

  function toggleContactDetails(index) {
    const detailsElement = document.getElementById(`contact-details-${index}`);
    const headerElement = detailsElement.previousElementSibling;
    
    if (detailsElement.classList.contains('active')) {
      detailsElement.classList.remove('active');
      headerElement.classList.remove('active');
    } else {
      // Close any open details first
      document.querySelectorAll('.contact-list-body.active').forEach(el => {
        el.classList.remove('active');
        el.previousElementSibling.classList.remove('active');
      });
      
      detailsElement.classList.add('active');
      headerElement.classList.add('active');
    }
  }

  function openAddContactModal() {
    currentContactId = null;
    const modal = document.getElementById('add-contact-modal');
    modal.classList.add('active');
    
    // Reset form
    document.getElementById('add-contact-form').reset();
    
    // Update modal title
    document.querySelector('#add-contact-modal .modal-header h3').innerHTML = 
      '<i class="fas fa-user-plus"></i> Add Emergency Contact';
  }

  function editContact(index) {
    currentContactId = index;
    const contact = emergencyContacts[index];
    const modal = document.getElementById('add-contact-modal');
    
    // Fill form with contact data
    document.getElementById('contact-name').value = contact.name;
    document.getElementById('contact-phone').value = contact.phone;
    document.getElementById('contact-relation').value = contact.relation;
    document.getElementById('contact-notes').value = contact.notes || '';
    
    // Update modal title
    document.querySelector('#add-contact-modal .modal-header h3').innerHTML = 
      '<i class="fas fa-edit"></i> Edit Emergency Contact';
    
    // Show modal
    modal.classList.add('active');
  }

  function saveContact() {
    const name = document.getElementById('contact-name').value;
    const phone = document.getElementById('contact-phone').value;
    const relation = document.getElementById('contact-relation').value;
    const notes = document.getElementById('contact-notes').value;
    
    if (!name || !phone || !relation) {
      alert('Please fill in all required fields.');
      return;
    }
    
    const contact = {
      name,
      phone,
      relation,
      notes
    };
    
    if (currentContactId !== null) {
      // Edit existing contact
      emergencyContacts[currentContactId] = contact;
    } else {
      // Add new contact
      emergencyContacts.push(contact);
    }
    
    localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
    
    closeModal('add-contact-modal');
    refreshContactsList();
    
    // Show success message
    const successMessage = currentContactId !== null ? 
      'Contact updated successfully!' : 
      'New emergency contact added successfully!';
    
    showSuccessOverlay('Success', successMessage);
  }

  // Format phone number for WhatsApp
  function formatPhoneForWhatsApp(phoneNumber) {
    // Remove any non-digit characters
    let digits = phoneNumber.replace(/\D/g, '');
    
    // Get the country from settings
    const country = emergencyConfig.country || 'US';
    
    // If no country code provided, add one based on country settings
    if (!phoneNumber.startsWith('+')) {
      switch(country) {
        case 'US':
        case 'CA':
          // Add US/Canada country code (+1)
          digits = '1' + digits;
          break;
        case 'UK':
          // Add UK country code (+44)
          digits = '44' + digits;
          break;
        case 'IN':
          // Add India country code (+91)
          digits = '91' + digits;
          break;
        case 'AU':
          // Add Australia country code (+61)
          digits = '61' + digits;
          break;
        case 'EU':
          // Default to international format without adding code
          // User should include country code manually
          break;
        default:
          // For other countries, assume code is already included or
          // user will add it manually
          break;
      }
    }
    
    return digits;
  }

  function removeContact(index) {
    const contact = emergencyContacts[index];
    
    if (confirm(`Are you sure you want to remove ${contact.name} from your emergency contacts?`)) {
      emergencyContacts.splice(index, 1);
      localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
      refreshContactsList();
    }
  }

  // Medical ID Functions
  function loadMedicalIdData() {
    document.getElementById('medical-id-name').textContent = medicalIdData.name;
    
    // Format date for display
    const dobDate = new Date(medicalIdData.dob);
    const formattedDob = dobDate.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric' 
    });
    
    document.getElementById('medical-id-dob').textContent = formattedDob;
    document.getElementById('medical-id-blood').textContent = medicalIdData.blood;
    document.getElementById('medical-id-allergies').textContent = medicalIdData.allergies || 'None';
    document.getElementById('medical-id-conditions').textContent = medicalIdData.conditions || 'None';
    document.getElementById('medical-id-medications').textContent = medicalIdData.medications || 'None';
  }

  function editMedicalId() {
    const modal = document.getElementById('edit-medical-id-modal');
    modal.classList.add('active');
    
    // Fill form with current data
    document.getElementById('medical-edit-name').value = medicalIdData.name;
    document.getElementById('medical-edit-dob').value = medicalIdData.dob;
    document.getElementById('medical-edit-blood').value = medicalIdData.blood;
    document.getElementById('medical-edit-allergies').value = medicalIdData.allergies;
    document.getElementById('medical-edit-conditions').value = medicalIdData.conditions;
    document.getElementById('medical-edit-medications').value = medicalIdData.medications;
  }

  function saveMedicalId() {
    const name = document.getElementById('medical-edit-name').value;
    const dob = document.getElementById('medical-edit-dob').value;
    const blood = document.getElementById('medical-edit-blood').value;
    
    if (!name || !dob || !blood) {
      alert('Please fill in all required fields.');
      return;
    }
    
    medicalIdData = {
      name,
      dob,
      blood,
      allergies: document.getElementById('medical-edit-allergies').value,
      conditions: document.getElementById('medical-edit-conditions').value,
      medications: document.getElementById('medical-edit-medications').value
    };
    
    localStorage.setItem('medicalIdData', JSON.stringify(medicalIdData));
    
    closeModal('edit-medical-id-modal');
    loadMedicalIdData();
  }

  function shareMedicalId() {
    // In a real app, this would open sharing options
    alert('Sharing Medical ID information...');
  }

  function downloadMedicalId() {
    // In a real app, this would generate a PDF
    alert('Downloading Medical ID as PDF...');
  }

  // First Aid Guide Functions
  function showFirstAidGuide(guideId) {
    const guide = firstAidGuides[guideId];
    
    if (!guide) {
      alert('Guide not found.');
      return;
    }
    
    const modal = document.getElementById('first-aid-modal');
    const titleElement = document.getElementById('first-aid-modal-title');
    const contentElement = document.getElementById('first-aid-modal-content');
    
    titleElement.innerHTML = `<i class="fas fa-first-aid"></i> ${guide.title}`;
    contentElement.innerHTML = guide.content;
    
    modal.classList.add('active');
  }

  function printFirstAidGuide() {
    window.print();
  }

  // Improved Emergency Functions
  let callCountdownInterval;
  let emergencyCallTimeout;

  function callEmergency() {
    // Show progress overlay
    document.getElementById('call-progress-overlay').style.display = 'flex';
    
    // Set countdown
    let countdown = 5;
    document.getElementById('call-countdown').textContent = countdown;
    
    // Start countdown
    callCountdownInterval = setInterval(() => {
      countdown--;
      document.getElementById('call-countdown').textContent = countdown;
      
      if (countdown <= 0) {
        clearInterval(callCountdownInterval);
        proceedWithEmergencyCall();
      }
    }, 1000);

    // Log the emergency call
    const timestamp = new Date().toISOString();
    const emergencyLogs = JSON.parse(localStorage.getItem('emergencyLogs')) || [];
    
    emergencyLogs.push({
      type: 'call',
      timestamp,
      status: 'initiated'
    });
    
    localStorage.setItem('emergencyLogs', JSON.stringify(emergencyLogs));
  }

  function proceedWithEmergencyCall() {
    document.getElementById('call-countdown').style.display = 'none';
    document.getElementById('call-progress-overlay').querySelector('.progress-status').textContent = 
      'Connecting to emergency services. Please hold...';
    
    // Make a direct emergency call
    try {
      // Get the emergency number from config
      const emergencyNumber = emergencyConfig.emergencyNumber;
      
      // Use the tel: protocol to make a direct call
      window.location.href = `tel:${emergencyNumber}`;
      
      // Show success message after a short delay
      emergencyCallTimeout = setTimeout(() => {
        document.getElementById('call-progress-overlay').style.display = 'none';
        
        // Update log
        const emergencyLogs = JSON.parse(localStorage.getItem('emergencyLogs')) || [];
        const lastLog = emergencyLogs[emergencyLogs.length - 1];
        
        if (lastLog && lastLog.type === 'call') {
          lastLog.status = 'connected';
          localStorage.setItem('emergencyLogs', JSON.stringify(emergencyLogs));
        }
      }, 1000);
    } catch (error) {
      // Show error message
      showErrorOverlay('Failed to initiate emergency call. Please dial emergency services manually.');
      
      // Update log
      const emergencyLogs = JSON.parse(localStorage.getItem('emergencyLogs')) || [];
      const lastLog = emergencyLogs[emergencyLogs.length - 1];
      
      if (lastLog && lastLog.type === 'call') {
        lastLog.status = 'failed';
        lastLog.error = error.message || 'Unknown error';
        localStorage.setItem('emergencyLogs', JSON.stringify(emergencyLogs));
      }
    }
  }

  function cancelEmergencyCall() {
    clearInterval(callCountdownInterval);
    clearTimeout(emergencyCallTimeout);
    document.getElementById('call-progress-overlay').style.display = 'none';
    
    // Update log
    const emergencyLogs = JSON.parse(localStorage.getItem('emergencyLogs')) || [];
    const lastLog = emergencyLogs[emergencyLogs.length - 1];
    
    if (lastLog && lastLog.type === 'call') {
      lastLog.status = 'cancelled';
      localStorage.setItem('emergencyLogs', JSON.stringify(emergencyLogs));
    }
  }

  function shareLocation() {
    // Show location progress overlay
    document.getElementById('location-progress-overlay').style.display = 'flex';
    
    // Actually use the geolocation API
    if (navigator.geolocation) {
      document.getElementById('location-status').textContent = 'Accessing your GPS location...';
      
      navigator.geolocation.getCurrentPosition(
        position => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          
          // Display the location information
          document.getElementById('location-lat').textContent = latitude.toFixed(6);
          document.getElementById('location-lng').textContent = longitude.toFixed(6);
          document.getElementById('location-accuracy').textContent = `${accuracy.toFixed(1)} meters`;
          document.getElementById('location-info').style.display = 'block';
          document.getElementById('location-status').textContent = 'Location detected. Sharing with emergency services...';
          
          // Log the location share
          const timestamp = new Date().toISOString();
          const emergencyLogs = JSON.parse(localStorage.getItem('emergencyLogs')) || [];
          
          emergencyLogs.push({
            type: 'location',
            timestamp,
            coordinates: { latitude, longitude, accuracy },
            status: 'detected'
          });
          
          localStorage.setItem('emergencyLogs', JSON.stringify(emergencyLogs));
          
          // Simulate sharing process
          setTimeout(() => {
            // In a real app, this would send the location to emergency services
            showSuccessOverlay('Location Shared', 'Your location has been successfully shared with emergency services.');
            
            // Update log
            const emergencyLogs = JSON.parse(localStorage.getItem('emergencyLogs')) || [];
            const lastLog = emergencyLogs[emergencyLogs.length - 1];
            
            if (lastLog && lastLog.type === 'location') {
              lastLog.status = 'shared';
              localStorage.setItem('emergencyLogs', JSON.stringify(emergencyLogs));
            }
          }, 2000);
        },
        error => {
          console.error('Error getting location:', error);
          
          // Show error message
          let errorMessage = 'Error sharing location.';
          
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = 'Location access denied. Please enable location services in your browser settings.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = 'Location information is unavailable. Please try again later.';
              break;
            case error.TIMEOUT:
              errorMessage = 'Location request timed out. Please try again.';
              break;
            default:
              errorMessage = 'An unknown error occurred while accessing your location.';
          }
          
          showErrorOverlay(errorMessage);
          
          // Update log
          const emergencyLogs = JSON.parse(localStorage.getItem('emergencyLogs')) || [];
          const lastLog = emergencyLogs[emergencyLogs.length - 1];
          
          if (lastLog && lastLog.type === 'location') {
            lastLog.status = 'failed';
            lastLog.error = errorMessage;
            localStorage.setItem('emergencyLogs', JSON.stringify(emergencyLogs));
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    } else {
      showErrorOverlay('Geolocation is not supported by this browser. Please use a modern browser with location services.');
    }
  }

  function cancelLocationSharing() {
    document.getElementById('location-progress-overlay').style.display = 'none';
    
    // Update log
    const emergencyLogs = JSON.parse(localStorage.getItem('emergencyLogs')) || [];
    const lastLog = emergencyLogs[emergencyLogs.length - 1];
    
    if (lastLog && lastLog.type === 'location') {
      lastLog.status = 'cancelled';
      localStorage.setItem('emergencyLogs', JSON.stringify(emergencyLogs));
    }
  }

  function showSuccessOverlay(title, message) {
    // Hide other overlays
    document.getElementById('call-progress-overlay').style.display = 'none';
    document.getElementById('location-progress-overlay').style.display = 'none';
    
    // Set success message
    document.getElementById('success-title').textContent = title;
    document.getElementById('success-message').textContent = message;
    
    // Show success overlay
    document.getElementById('success-overlay').style.display = 'flex';
  }

  function showErrorOverlay(message) {
    // Hide other overlays
    document.getElementById('call-progress-overlay').style.display = 'none';
    document.getElementById('location-progress-overlay').style.display = 'none';
    
    // Set error message
    document.getElementById('error-message').textContent = message;
    
    // Show error overlay
    document.getElementById('error-overlay').style.display = 'flex';
  }

  function closeSuccessOverlay() {
    document.getElementById('success-overlay').style.display = 'none';
  }

  function closeErrorOverlay() {
    document.getElementById('error-overlay').style.display = 'none';
  }

  // Utility Functions
  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove('active');
      
      // If this is a dynamically created modal, remove it from the DOM
      if (modalId === 'whatsapp-message-modal') {
        setTimeout(() => {
          modal.remove();
        }, 300); // Allow time for the animation to complete
      }
    }
  }

  

  // Emergency Settings Functions
  function openEmergencySettings() {
    // Show the settings modal
    const modal = document.getElementById('emergency-settings-modal');
    modal.classList.add('active');
    
    // Fill the form with current settings
    document.getElementById('emergency-number').value = emergencyConfig.emergencyNumber;
    document.getElementById('emergency-country').value = emergencyConfig.country;
    
    // Add event listener for country selection
    document.getElementById('emergency-country').addEventListener('change', function() {
      const country = this.value;
      let defaultNumber = '';
      
      // Set default emergency number based on country
      switch(country) {
        case 'US':
        case 'CA':
          defaultNumber = '911';
          break;
        case 'UK':
          defaultNumber = '999';
          break;
        case 'EU':
          defaultNumber = '112';
          break;
        case 'AU':
          defaultNumber = '000';
          break;
        case 'IN':
          defaultNumber = '112';
          break;
        default:
          // Keep current value
          return;
      }
      
      document.getElementById('emergency-number').value = defaultNumber;
    });
  }

  function saveEmergencySettings() {
    const emergencyNumber = document.getElementById('emergency-number').value.trim();
    const country = document.getElementById('emergency-country').value;
    
    if (!emergencyNumber) {
      alert('Please enter an emergency number.');
      return;
    }
    
    // Save settings to config object
    emergencyConfig.emergencyNumber = emergencyNumber;
    emergencyConfig.country = country;
    
    // Save to localStorage
    localStorage.setItem('emergencyConfig', JSON.stringify(emergencyConfig));
    
    // Update the emergency call button text
    updateEmergencyButtonText();
    
    // SOS panel emergency numbers update removed
    
    // Close modal
    closeModal('emergency-settings-modal');
    
    // Show success message
    showSuccessOverlay('Settings Saved', 'Your emergency settings have been updated successfully.');
  }

  function loadEmergencySettings() {
    // This function is called on page load to initialize the settings
    // The default settings are already loaded in the config object initialization
    console.log('Emergency settings loaded:', emergencyConfig);
  }

  // Function to show WhatsApp help modal
  function showWhatsAppHelp() {
    document.getElementById('whatsapp-help-modal').classList.add('active');
  }

  // SOS Mode Functions
  // toggleSOSMode, populateSOSContacts, shareLocationSOS, updateSOSEmergencyNumbers functions have been removed as they're no longer needed
  
</script>
<!-- Direct calling and SMS handling -->
<script src="/static/app.js"></script>
<!-- Emergency-specific chatbot fix -->
<script src="{{ url_for('static', filename='emergency-debug.js') }}"></script>
{% endblock %}
{% endblock %}
