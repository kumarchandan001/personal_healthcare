{% extends "admin_layout.html" %}

{% block title %}Health Monitoring - Admin Dashboard{% endblock %}

{% block header_title %}Health Monitoring Data{% endblock %}

{% block additional_styles %}
<style>
  :root {
    --primary: #4f46e5;
    --primary-light: rgba(79, 70, 229, 0.1);
    --primary-dark: #4338ca;
    --secondary: #0ea5e9;
    --secondary-light: rgba(14, 165, 233, 0.1);
    --accent: #f59e0b;
    --accent-light: rgba(245, 158, 11, 0.1);
    --white: #ffffff;
    --text: #1f2937;
    --text-light: #6b7280;
    --glass-bg: rgba(255, 255, 255, 0.8);
    --glass-border: rgba(209, 213, 219, 0.5);
    --glass-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --border-radius: 8px;
    --transition: all 0.2s ease-in-out;
}

body { 
    font-family: Arial, sans-serif; 
    margin: 0; 
    padding: 0; 
    background-color: #f5f5f5;
    color: var(--text);
}

.container { 
    max-width: 1200px; 
    margin: 0 auto; 
    padding: 20px; 
}

header { 
    background-color: #333; 
    color: white; 
    padding: 10px 20px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
}

.header-title { 
    font-size: 20px; 
    font-weight: bold; 
}

nav { 
    margin-top: 20px; 
    background-color: white; 
    padding: 15px; 
    border-radius: var(--border-radius); 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
}

nav ul { 
    list-style: none; 
    padding: 0; 
    margin: 0; 
    display: flex; 
    flex-wrap: wrap; 
}

nav ul li { 
    margin-right: 20px; 
    margin-bottom: 5px; 
}

nav ul li a { 
    text-decoration: none; 
    color: var(--text); 
    font-weight: bold;
    transition: var(--transition);
}

nav ul li a:hover {
    color: var(--primary);
}

.card { 
    background-color: white; 
    border-radius: var(--border-radius); 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    margin-bottom: 20px; 
    overflow: hidden; 
}

.card-header {
    background-color: var(--primary);
    color: white;
    padding: 15px;
    font-weight: bold;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.card-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.card-body { 
    padding: 15px; 
}

table { 
    width: 100%; 
    border-collapse: collapse; 
}

th, td { 
    padding: 12px 15px; 
    text-align: left; 
    border-bottom: 1px solid #ddd; 
}

th { 
    background-color: var(--primary-light); 
    color: var(--primary); 
    font-weight: 600; 
    white-space: nowrap; 
}

tr:hover { 
    background-color: #f5f5f5; 
}

.logout { 
    color: white; 
    text-decoration: none;
    transition: var(--transition);
}

.logout:hover {
    opacity: 0.8;
}

.search-tools {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    padding: 0;
    background-color: transparent;
    box-shadow: none;
}

.search-tools input, 
.search-tools select { 
    padding: 12px 15px; 
    border: 1px solid var(--glass-border); 
    border-radius: var(--border-radius); 
    background-color: var(--white);
    transition: var(--transition);
    flex: 1;
    min-width: 150px;
    font-size: 1rem;
}

.search-tools input:focus, 
.search-tools select:focus { 
    border-color: var(--primary); 
    outline: none; 
    box-shadow: 0 0 0 3px var(--primary-light); 
}

.view-link { 
    color: var(--primary); 
    text-decoration: none;
    transition: var(--transition);
}

.view-link:hover { 
    text-decoration: underline; 
}

.pagination { 
    display: flex; 
    justify-content: center; 
    margin-top: 25px;
    gap: 8px;
}

.pagination a { 
    padding: 10px 15px; 
    border-radius: var(--border-radius); 
    background-color: var(--glass-bg); 
    text-decoration: none; 
    color: var(--primary); 
    transition: var(--transition);
    border: 1px solid var(--glass-border);
}

.pagination a:hover { 
    background-color: var(--primary-light);
    transform: translateY(-2px);
}

.pagination a.active { 
    background-color: var(--primary);
    color: white; 
    font-weight: bold;
}

.stats-cards { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 20px; 
    margin-bottom: 30px; 
}

.stat-card { 
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    padding: 25px 15px;
    box-shadow: var(--glass-shadow);
    flex: 1; 
    min-width: 200px; 
    text-align: center;
    transition: var(--transition);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.stat-value { 
    font-size: 32px; 
    font-weight: bold; 
    color: var(--primary);
    margin-bottom: 10px; 
}

.stat-label { 
    color: var(--text-light);
    font-size: 1rem;
}

.health-status { 
    padding: 5px 10px; 
    border-radius: 20px; 
    font-size: 12px; 
    font-weight: bold; 
    display: inline-block; 
}

.health-status.normal { 
    background-color: var(--secondary-light); 
    color: var(--secondary); 
}

.health-status.warning { 
    background-color: var(--accent-light); 
    color: var(--accent); 
}

.health-status.alert { 
    background-color: rgba(220, 38, 38, 0.2);
    color: #dc2626;
    font-weight: 700;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: var(--transition);
    background-color: var(--glass-bg);
}

.btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background-color: var(--primary);
    color: white;
    text-decoration: none;
    padding: 8px 15px;
    border-radius: var(--border-radius);
    font-size: 0.9rem;
    transition: var(--transition);
    border: none;
    cursor: pointer;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
}

.btn-primary.btn-sm {
    padding: 6px 12px;
    font-size: 0.85rem;
}

/* Record type styling */
.record-type { 
    padding: 3px 8px; 
    border-radius: 20px; 
    font-size: 12px; 
    font-weight: bold; 
    background-color: #e0e0e0; 
}

.record-type.lab { 
    background-color: #c6f6d5; 
    color: #22543d; 
}

.record-type.prescription { 
    background-color: #bee3f8; 
    color: #2c5282; 
}

.record-type.imaging { 
    background-color: #e9d8fd; 
    color: #553c9a; 
}

.record-type.vaccination { 
    background-color: #feebc8; 
    color: #7b341e; 
}
</style>
{% endblock %}

{% block content %}
<!-- Debug Information section removed -->

<!-- Statistics Overview -->
<div class="stats-cards">
    <div class="stat-card">
        <div class="stat-value" id="total-entries">{{ health_entries|length }}</div>
        <div class="stat-label">Total Readings</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="avg-heart-rate">0</div>
        <div class="stat-label">Avg. Heart Rate</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="avg-oxygen">0</div>
        <div class="stat-label">Avg. Oxygen Level</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="avg-glucose">0</div>
        <div class="stat-label">Avg. Glucose</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="alert-count">0</div>
        <div class="stat-label">Alert Readings</div>
    </div>
</div>

<!-- Search box with improved styling -->
<div class="card">
    <div class="card-header">
        <h3>Search & Filter</h3>
    </div>
    <div class="card-body">
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            <div style="flex: 1; min-width: 200px;">
                <label for="search-user" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Username</label>
                <input type="text" id="search-user" placeholder="Search by username..." class="form-control">
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label for="filter-status" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Health Status</label>
                <select id="filter-status" class="form-control">
                    <option value="all">All Statuses</option>
                    <option value="normal">Normal</option>
                    <option value="warning">Warning</option>
                    <option value="alert">Alert</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label for="filter-date" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">Date</label>
                <input type="date" id="filter-date" class="form-control">
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>All Health Monitoring Data</h3>
    </div>
    {% if health_entries and health_entries|length > 0 %}
    <div class="card-body" style="padding: 0;">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th style="width: 120px;">User</th>
                    <th>Heart Rate</th>
                    <th>Blood Pressure</th>
                    <th>Oxygen Level</th>
                    <th>Temperature</th>
                    <th>Glucose</th>
                    <th style="width: 100px;">Status</th>
                    <th>Date</th>
                    <th style="width: 120px;">Actions</th>
                </tr>
            </thead>
            <tbody id="health-table">
                {% for entry in health_entries %}
                <tr>
                    <td>{{ entry.id }}</td>
                    <td>
                        <span class="badge badge-primary" style="background-color: var(--primary-light); color: var(--primary); padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                            {{ entry.username }}
                        </span>
                    </td>
                    <td>{{ entry.heart_rate if entry.heart_rate else '-' }} {% if entry.heart_rate %}bpm{% endif %}</td>
                    <td>
                        {% if entry.blood_pressure and entry.blood_pressure.systolic and entry.blood_pressure.diastolic %}
                            {{ entry.blood_pressure.systolic }}/{{ entry.blood_pressure.diastolic }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ entry.oxygen_level if entry.oxygen_level else '-' }}{% if entry.oxygen_level %}%{% endif %}</td>
                    <td>{{ entry.body_temperature if entry.body_temperature else '-' }}{% if entry.body_temperature %}°C{% endif %}</td>
                    <td>{{ entry.glucose_level if entry.glucose_level else '-' }}</td>
                    <td>
                        {% set status = 'normal' %}
                        {% if entry.heart_rate and (entry.heart_rate > 100 or entry.heart_rate < 60) or 
                            (entry.blood_pressure and entry.blood_pressure.systolic and entry.blood_pressure.systolic > 140) or
                            (entry.blood_pressure and entry.blood_pressure.diastolic and entry.blood_pressure.diastolic > 90) or
                            (entry.oxygen_level and entry.oxygen_level < 95) or
                            (entry.body_temperature and entry.body_temperature > 37.5) or
                            (entry.glucose_level and entry.glucose_level > 140) %}
                            {% set status = 'warning' %}
                        {% endif %}
                        {% if entry.heart_rate and (entry.heart_rate > 120 or entry.heart_rate < 50) or 
                            (entry.blood_pressure and entry.blood_pressure.systolic and entry.blood_pressure.systolic > 160) or
                            (entry.blood_pressure and entry.blood_pressure.diastolic and entry.blood_pressure.diastolic > 100) or
                            (entry.oxygen_level and entry.oxygen_level < 90) or
                            (entry.body_temperature and entry.body_temperature > 38) or
                            (entry.glucose_level and entry.glucose_level > 200) %}
                            {% set status = 'alert' %}
                        {% endif %}
                        <span class="health-status {{ status }}" data-status="{{ status }}">{{ status|title }}</span>
                    </td>
                    <td>{{ entry.created_at }}</td>
                    <td>
                        <a href="{{ url_for('user_history', user_id=entry.user_id) }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-eye"></i> View
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="card-body">
        <p class="text-center" style="padding: 40px 20px; color: var(--text-light); font-size: 1.1rem;">
            No health monitoring data available. This could be because the health_monitoring table doesn't exist
            in the database or there are no records yet.
        </p>
        
        <!-- Show a sample table structure to illustrate what data would look like -->
        <div style="margin-top: 20px; border-top: 1px solid var(--glass-border); padding-top: 20px;">
            <h4 style="margin-bottom: 15px; color: var(--primary);">Sample Health Data Structure</h4>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Heart Rate</th>
                        <th>Blood Pressure</th>
                        <th>Oxygen Level</th>
                        <th>Temperature</th>
                        <th>Glucose</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="opacity: 0.6;">
                        <td>1</td>
                        <td>Sample User</td>
                        <td>75 bpm</td>
                        <td>120/80</td>
                        <td>98%</td>
                        <td>36.8°C</td>
                        <td>100</td>
                        <td><span class="health-status normal" data-status="normal">Normal</span></td>
                        <td>2023-05-01</td>
                    </tr>
                    <tr style="opacity: 0.6;">
                        <td>2</td>
                        <td>Sample User</td>
                        <td>95 bpm</td>
                        <td>135/90</td>
                        <td>96%</td>
                        <td>37.2°C</td>
                        <td>130</td>
                        <td><span class="health-status warning" data-status="warning">Warning</span></td>
                        <td>2023-05-02</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

{% if health_entries and health_entries|length > 0 and health_entries|length > 10 %}
<div class="pagination">
    {% set total_pages = (health_entries|length + 9) // 10 %}
    {% for p in range(1, total_pages + 1) %}
    <a href="#" class="{% if loop.first %}active{% endif %}" data-page="{{ p }}">{{ p }}</a>
    {% endfor %}
    {% if total_pages > 1 %}
    <a href="#" class="next-page">Next »</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const healthTable = document.getElementById('health-table');
        
        // Only run if we have health data
        if (healthTable) {
            const searchInput = document.getElementById('search-user');
            const statusFilter = document.getElementById('filter-status');
            const dateFilter = document.getElementById('filter-date');
            const rows = healthTable.querySelectorAll('tr');
            
            // Pagination variables
            let currentPage = 1;
            const rowsPerPage = 10;
            
            // Set up pagination click handlers
            const paginationLinks = document.querySelectorAll('.pagination a[data-page]');
            const nextPageLink = document.querySelector('.pagination .next-page');
            
            if (paginationLinks.length > 0) {
                paginationLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const page = parseInt(this.getAttribute('data-page'));
                        changePage(page);
                    });
                });
            }
            
            if (nextPageLink) {
                nextPageLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (currentPage < Math.ceil(rows.length / rowsPerPage)) {
                        changePage(currentPage + 1);
                    }
                });
            }
            
            // Function to change page
            function changePage(page) {
                currentPage = page;
                let start = (page - 1) * rowsPerPage;
                let end = start + rowsPerPage;
                let rowIndex = 0;
                
                // Only count visible rows (after filtering)
                const visibleRows = [];
                rows.forEach(row => {
                    if (row.style.display !== 'none') {
                        visibleRows.push(row);
                    }
                });
                
                // Show/hide rows based on pagination
                for (let i = 0; i < visibleRows.length; i++) {
                    if (i >= start && i < end) {
                        visibleRows[i].style.display = '';
                    } else {
                        visibleRows[i].style.display = 'none';
                    }
                }
                
                // Update active page in pagination
                paginationLinks.forEach(link => {
                    link.classList.remove('active');
                    if (parseInt(link.getAttribute('data-page')) === page) {
                        link.classList.add('active');
                    }
                });
            }
            
            // Calculate statistics
            let totalHeartRate = 0;
            let heartRateCount = 0;
            let totalOxygen = 0;
            let oxygenCount = 0;
            let totalGlucose = 0;
            let glucoseCount = 0;
            let alertCount = 0;
            
            rows.forEach(row => {
                // Heart rate
                const heartRateText = row.querySelector('td:nth-child(3)').textContent.trim();
                const heartRate = parseInt(heartRateText);
                if (!isNaN(heartRate)) {
                    totalHeartRate += heartRate;
                    heartRateCount++;
                }
                
                // Oxygen level
                const oxygenText = row.querySelector('td:nth-child(5)').textContent.trim();
                const oxygen = parseInt(oxygenText);
                if (!isNaN(oxygen)) {
                    totalOxygen += oxygen;
                    oxygenCount++;
                }
                
                // Glucose level
                const glucoseText = row.querySelector('td:nth-child(7)').textContent.trim();
                if (glucoseText !== '-') {
                    const glucose = parseFloat(glucoseText);
                    if (!isNaN(glucose)) {
                        totalGlucose += glucose;
                        glucoseCount++;
                    }
                }
                
                // Status (count alerts)
                const statusSpan = row.querySelector('.health-status');
                if (statusSpan && statusSpan.getAttribute('data-status') === 'alert') {
                    alertCount++;
                }
            });
            
            // Update the stats cards
            if (document.getElementById('avg-heart-rate')) {
                document.getElementById('avg-heart-rate').textContent = heartRateCount > 0 ? Math.round(totalHeartRate / heartRateCount) : 0;
            }
            
            if (document.getElementById('avg-oxygen')) {
                document.getElementById('avg-oxygen').textContent = oxygenCount > 0 ? Math.round(totalOxygen / oxygenCount) : 0;
            }
            
            if (document.getElementById('avg-glucose')) {
                document.getElementById('avg-glucose').textContent = glucoseCount > 0 ? Math.round(totalGlucose / glucoseCount) : 0;
            }
            
            if (document.getElementById('alert-count')) {
                document.getElementById('alert-count').textContent = alertCount;
            }
            
            // Filter function
            function filterHealthEntries() {
                const searchTerm = searchInput.value.toLowerCase();
                const filterStatus = statusFilter.value;
                const filterDateVal = dateFilter.value;
                
                rows.forEach(row => {
                    const username = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    const statusSpan = row.querySelector('.health-status');
                    const status = statusSpan ? statusSpan.getAttribute('data-status') : '';
                    const entryDate = row.querySelector('td:nth-child(9)').textContent;
                    
                    const nameMatch = username.includes(searchTerm);
                    const statusMatch = filterStatus === 'all' || status === filterStatus;
                    const dateMatch = !filterDateVal || entryDate.includes(filterDateVal);
                    
                    row.style.display = nameMatch && statusMatch && dateMatch ? '' : 'none';
                });
                
                // After filtering, reset to page 1
                changePage(1);
            }
            
            // Add event listeners
            if (searchInput) {
                searchInput.addEventListener('input', filterHealthEntries);
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', filterHealthEntries);
            }
            
            if (dateFilter) {
                dateFilter.addEventListener('change', filterHealthEntries);
            }
            
            // Initialize first page
            if (paginationLinks.length > 0) {
                changePage(1);
            }
        }
    });
</script>
{% endblock %} 